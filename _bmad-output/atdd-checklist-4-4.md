# ATDD Checklist - Epic 4, Story 4: Validation et Mise à Jour du Rang

**Date:** 2026-01-25
**Author:** Zaès (Generated by BMad TEA Agent)
**Primary Test Level:** API (Integration)

---

## Story Summary

As a MJ, I want to validate a Renown Request and see the player's rank evolve, so that the narrative progression is visually reflected.

**As a** MJ
**I want** valider un Haut Fait et voir le rang du joueur évoluer
**So that** la progression narrative soit reflétée visuellement

---

## Acceptance Criteria

1.  **Given** un MJ qui valide un Haut Fait sur `/werewolf/admin/renown`
2.  **When** il clique sur "Valider"
3.  **Then** le statut de la demande passe à "approved" en base de données
4.  **And** le système recalcule le rang du joueur basé sur son total de Renommée validée
    - 0-2 Renommée: Rang 1 (Cliath)
    - 3-9 Renommée: Rang 2 (Fostern)
    - 10-19 Renommée: Rang 3 (Adren)
    - 20-29 Renommée: Rang 4 (Athro)
    - 30+ Renommée: Rang 5 (Elder)
5.  **And** si le rang augmente, la table `werewolf_data` est mise à jour
6.  **And** le joueur reçoit une notification Discord (DM ou Mention dans channel Logs) confirmant la validation et le nouveau rang
7.  **And** le composant `RenownBadge` sur la fiche du joueur reflète immédiatement le nouveau rang

---

## Failing Tests Created (RED Phase)

> **Note**: Tests have been verified as PASSING (Green Phase) as implementation is complete.

### API/Integration Tests (4 tests)

**File:** `tests/modules/werewolf/test_renown_validation_atdd.py`

- ✅ **Test:** `test_rank_calculation_logic_unit`
  - **Status:** GREEN (Initially RED)
  - **Verifies:** Rank calculation thresholds (0-2 -> 1, 3-9 -> 2, etc.)
  
- ✅ **Test:** `test_rank_update_persisted`
  - **Status:** GREEN (Initially RED)
  - **Verifies:** Database update logic for rank changes

- ✅ **Test:** `test_discord_notification_content`
  - **Status:** GREEN (Initially RED)
  - **Verifies:** Notification service constructs correct message with rank info

- ✅ **Test:** `test_validate_request_triggers_rank_update`
  - **Status:** GREEN (Initially RED)
  - **Verifies:** Full chain triggering: Validate -> Status Change -> Recalculate -> Update -> Notify

### Component Tests (2 tests)

**File:** `web/src/modules/werewolf/pages/RenownAdminPage.test.jsx`

- ✅ **Test:** `renders list of requests`
  - **Status:** GREEN
  - **Verifies:** Requests list display

- ✅ **Test:** `calls validate and shows success toast on click`
  - **Status:** GREEN
  - **Verifies:** 'Valider' button connects to API and shows feedback

---

## Data Factories Created

Factories used via Mocks/Fixtures:
- `RenownService` mock
- `NotificationService` mock
- `Discord` client async mock

---

## Fixtures Created

pytest fixtures implicit in `conftest.py` (not shown but `AsyncMock` and `patch` heavily used).

---

## Mock Requirements

### Discord Bot Mock

- **Service:** Discord Client (`discord.Client` / `discord.User`)
- **Method:** `user.send(message)`
- **Behavior:** Should verify message content includes title and new rank.

---

## Required data-testid Attributes

### Renown Admin Page

- `validate-btn-{id}` (implied by test `getByText(/Valider/i)`)
- `toast-message` (implied by test `getByText(/Demande validée/i)`)

---

## Implementation Checklist

### Backend: Renown Service Logic
- [x] Implement `update_request_status` (Pending -> Approved)
- [x] Implement `recalculate_player_rank` with thresholds
- [x] Trigger rank recalculation on approval
- [x] Logger rank changes

### Backend: Discord Notification
- [x] Create `notify_renown_update`
- [x] Send DM/Log channel message via Bot

### Backend: API Endpoint
- [x] Endpoint `POST /api/modules/werewolf/admin/renown/{id}/validate`
- [x] Connect logical flow

### Frontend: Wiring
- [x] Implement `validateRequest` in `useRenownAdmin`
- [x] Connect UI Button to Hook
- [x] Display Success Toast

---

## Running Tests

```bash
# Run backend ATDD tests
pytest tests/modules/werewolf/test_renown_validation_atdd.py

# Run frontend component tests
npm test web/src/modules/werewolf/pages/RenownAdminPage.test.jsx
```

---

## Red-Green-Refactor Workflow

### RED Phase (Complete) ✅

- Tests were defined in `test_renown_validation_atdd.py` with `try/except` blocks for missing modules.
- Initially failed due to `ImportError` or `NotImplementedError`.

### GREEN Phase (Complete) ✅

- Implementation completed in `modules.werewolf`.
- Tests now PASS.

### REFACTOR Phase (Complete) ✅

- Code integrated and verified.

---

**Generated by BMad TEA Agent** - 2026-01-25
