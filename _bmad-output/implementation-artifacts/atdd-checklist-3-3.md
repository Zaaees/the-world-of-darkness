# ATDD Checklist - Epic 3, Story 3.3: Synchronisation Discord (Live Sync)

**Date:** 2026-01-24
**Author:** Antigravity (ATDD Workflow)
**Primary Test Level:** Integration (Backend) + Component (Frontend)

---

## Story Summary

As a player, I want my character sheet updates to be synchronized to the Discord thread so that other members always see the most recent version.

---

## Acceptance Criteria

1. **Given** a sheet is modified and saved
2. **When** the system triggers sync to Discord
3. **Then** the existing Discord thread is updated with new content
4. **And** a toast confirms "Synchronisé avec Discord"
5. **And** if sync fails, a silent fallback occurs (Log error, Toast "Sauvegarde locale uniquement")
6. **And** Discord Rate Limits are respected

---

## Failing Tests Created (RED Phase)

### Backend Tests (Integration)

**File:** `modules/werewolf/tests/test_sheet_discord_sync.py`

- ✅ **Test:** `test_sync_sheet_to_discord_success`
  - **Status:** RED - `SheetService module not found` / Implementation missing
  - **Verifies:** `sync_sheet_to_discord` fetches the correct thread and edits the message.

- ✅ **Test:** `test_sync_sheet_to_discord_failure_silent`
  - **Status:** RED - `SheetService module not found`
  - **Verifies:** Discord exceptions are caught and logged, preventing app crash.

### Frontend Tests (Component)

**File:** `web/src/modules/werewolf/components/__tests__/StoryEditorSync.test.jsx`

- ✅ **Test:** `displays "Synchronisé avec Discord" toast when save returns sync confirmation`
  - **Status:** RED - Expected toast not found
  - **Verifies:** UI feedback for successful sync.

- ✅ **Test:** `displays "Sauvegarde locale uniquement" when sync fails`
  - **Status:** RED - Expected toast not found
  - **Verifies:** UI feedback for partial success (local save only).

---

## Mock Requirements

### Backend (Python)
- **`discord` Library**: Mock `discord.Thread` and `message.edit`.
- **`get_discord_thread`**: Helper function to retrieve thread object by ID.

### Frontend (React/Vitest)
- **`onSave` prop**: Must return `{ success: true, synced_to_discord: boolean }` to trigger the appropriate toast.

---

## Implementation Checklist

### Backend
- [ ] Create `modules/werewolf/services/sheet.py` if not exists.
- [ ] Implement `get_discord_thread(thread_id)` helper.
- [ ] Implement `sync_sheet_to_discord(sheet_data)` method:
    - [ ] Fetch thread using ID.
    - [ ] Fetch initial message.
    - [ ] Call `message.edit(content=...)`.
    - [ ] Wrap in try/except for `discord.HTTPException`, `discord.Forbidden`.
    - [ ] Log errors on failure.
- [ ] Integrate into `update_sheet` or similar existing method.

### Frontend
- [ ] Update `StoryEditor.jsx`:
    - [ ] Handle `onSave` response.
    - [ ] Check `synced_to_discord` flag.
    - [ ] Show "Synchronisé avec Discord" toast on success.
    - [ ] Show "Sauvegarde locale uniquement" toast if `synced_to_discord` is false.

---

## Running Tests

```bash
# Backend
pytest modules/werewolf/tests/test_sheet_discord_sync.py

# Frontend
npm run test -- web/src/modules/werewolf/components/__tests__/StoryEditorSync.test.jsx
```

---

## Red-Green-Refactor Workflow

### RED Phase (Complete) ✅
- Tests written and confirmed failing.
- Mocks defined.

### GREEN Phase (DEV Team - Next Steps)
1. Pick one failing test (e.g., Backend Success).
2. Implement `sync_sheet_to_discord`.
3. Verify test passes.
4. Pick next test (Frontend Toast).
5. Implement UI feedback.
6. Verify all tests pass.

---
**Generated by BMad ATDD Workflow**
