# ATDD Checklist - Story 3.4: Audit Log des Modifications

**Date:** 2026-01-24
**Author:** Zaès (via ATDD Workflow)
**Primary Test Level:** Integration (Service Level)

---

## Story Summary

**As a** MJ,
**I want** un historique des modifications de chaque fiche,
**So that** je puisse suivre l'évolution des personnages.

---

## Acceptance Criteria

1. **Given** une modification validée sur une fiche (StoryEditor ou autres champs éditables)
2. **When** le système sauvegarde les changements
3. **Then** un message est posté dans le canal de logs dédié (`1457856977660022844`)
4. **And** le message contient : Nom du joueur, Nom du Personnage, Date/Heure, et un Résumé des changements (Diff simplifié)
5. **And** si la modification est mineure (ex: < 10 caractères) ou purement technique, elle est quand même loggée
6. **And** le log est asynchrone (ne bloque pas la sauvegarde joueur)

---

## Failing Tests Created (RED Phase)

### Service Tests (5 tests)

**File:** `tests/modules/werewolf/test_audit_atdd.py`

- ✅ **Test:** `test_calculate_diff_changes`
  - **Status:** RED - Module services.audit not found
  - **Verifies:** `calculate_diff` returns correct list of strings for changed data

- ✅ **Test:** `test_calculate_diff_no_changes`
  - **Status:** RED - Module services.audit not found
  - **Verifies:** `calculate_diff` returns empty list for identical data

- ✅ **Test:** `test_log_character_update_sends_discord_message`
  - **Status:** RED - Module services.audit not found
  - **Verifies:** Discord bot is called with correct channel ID and message content contains user/character/diff

- ✅ **Test:** `test_log_character_update_minor_modification`
  - **Status:** RED - Module services.audit not found
  - **Verifies:** Small modifications are still logged (AC 5)

- ✅ **Test:** `test_audit_constant_exists`
  - **Status:** RED - Module services.audit not found
  - **Verifies:** `AUDIT_CHANNEL_ID` is defined

---

## Data Factories & Fixtures

- **Existing Model:** `WerewolfData` (used in tests via direct instantiation or existing factory if needed).
- **Mocks:** `AsyncMock` for Discord Bot and Channel interaction.

---

## Mock Requirements

### Discord Service Mock

**Channel ID:** `1457856977660022844`

**Expected Behavior:**
- `bot.get_channel(1457856977660022844)` should return a `TextChannel` mock.
- `channel.send(content=..., embed=...)` should be called.

---

## Implementation Checklist

### Test: test_audit_constant_exists & test_calculate_diff_*

**File:** `modules/werewolf/services/audit.py`

- [ ] Créer le fichier `modules/werewolf/services/audit.py`
- [ ] Définir `AUDIT_CHANNEL_ID = 1457856977660022844`
- [ ] Implémenter `calculate_diff(old: WerewolfData, new: WerewolfData) -> List[str]`
- [ ] Comparer champ par champ (au moins les principaux: name, breed, auspice, tribe, traits, bio)
- [ ] Run test: `pytest tests/modules/werewolf/test_audit_atdd.py`

### Test: test_log_character_update_*

**File:** `modules/werewolf/services/audit.py` & `modules/werewolf/routes.py`

- [ ] Implémenter `log_character_update(bot, user, character, changes)`
- [ ] Formater le message (Embed ou texte simple) avec Timestamp, User, Character, Diff
- [ ] Récupérer le canal via `bot.get_channel(AUDIT_CHANNEL_ID)`
- [ ] Envoyer le message de façon asynchrone (fire and forget ou await safe)
- [ ] **Integration (`routes.py`):**
    - [ ] Dans la route update, capturer `old_data` avant update
    - [ ] Calculer `diff = calculate_diff(old_data, new_data)`
    - [ ] Appeler `log_character_update` si diff non vide
- [ ] Run test: `pytest tests/modules/werewolf/test_audit_atdd.py`

---

## Running Tests

```bash
# Run failing tests
pytest tests/modules/werewolf/test_audit_atdd.py

# Run with verbose output
pytest -v tests/modules/werewolf/test_audit_atdd.py
```

---

## Red-Green-Refactor Workflow

### RED Phase (Complete) ✅

**TEA Agent Responsibilities:**
- ✅ Failing tests created: `tests/modules/werewolf/test_audit_atdd.py`
- ✅ Implementation Checklist defined.

### GREEN Phase (DEV Team - Next Steps)

1. **Implement minimal code** to make `test_audit_constant_exists` and `test_calculate_diff` pass.
2. **Implement generic logging logic** for `test_log_character_update`.
3. **Verify all tests pass**.

### REFACTOR Phase

1. **Optimize diff calculation** (maybe generic reflection instead of hardcoded fields).
2. **Ensure tests still pass**.

---

**Generated by BMad TEA Agent** - 2026-01-24
